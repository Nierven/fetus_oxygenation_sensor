#include "filter.h"
#include "string.h"

CircularBuffer x_red;
CircularBuffer x_ir;
CircularBuffer x_ir_filtered;
CircularBuffer x_red_filtered;

static int16_t *h = NULL;
static int16_t h_len = 0;

static int16_t hlp_05[FILTER_LENGTH] = { -0,-5,-13,-26,-41,-56,-68,-72,-65,-42,0,60,136,222,305,374,412,404,338,203,-0,-264,-569,-888,-1182,-1406,-1514,-1458,-1202,-719,0,945,2086,3371,4732,6090,7356,8448,9288,9818,9999,9818,9288,8448,7356,6090,4732,3371,2086,945,0,-719,-1202,-1458,-1514,-1406,-1182,-888,-569,-264,-0,203,338,404,412,374,305,222,136,60,0,-42,-65,-72,-68,-56,-41,-26,-13,-5,-0 };
static int16_t hlp_15[FILTER_LENGTH] = { -2,-21,-48,-58,-21,74,193,256,174,-89,-450,-713,-647,-127,728,1526,1736,965,-755,-2802,-4093,-3474,-256,5359,12178,18350,22016,22016,18350,12178,5359,-256,-3474,-4093,-2802,-755,965,1736,1526,728,-127,-647,-713,-450,-89,174,256,193,74,-21,-58,-48,-21,-2 };
static int16_t hbp_03[FILTER_LENGTH] = { 3,-7,-17,-28,-40,-53,-65,-78,-91,-104,-117,-129,-140,-151,-161,-169,-177,-183,-187,-190,-192,-192,-190,-186,-181,-174,-166,-157,-146,-135,-122,-109,-95,-81,-68,-54,-41,-29,-18,-8,-0,6,10,12,12,9,4,-4,-15,-28,-44,-62,-83,-106,-131,-157,-185,-215,-245,-275,-306,-336,-366,-394,-421,-446,-469,-489,-507,-521,-531,-538,-541,-540,-535,-526,-513,-496,-475,-451,-424,-393,-361,-326,-290,-253,-216,-179,-142,-107,-74,-44,-17,6,25,39,48,51,48,39,23,1,-28,-63,-105,-152,-205,-263,-326,-392,-462,-535,-608,-683,-757,-830,-900,-967,-1030,-1087,-1137,-1180,-1214,-1239,-1253,-1257,-1248,-1228,-1194,-1148,-1088,-1015,-929,-829,-717,-592,-455,-308,-151,16,191,372,560,751,945,1140,1336,1529,1719,1904,2082,2253,2414,2564,2702,2827,2938,3033,3113,3175,3220,3247,3256,3247,3220,3175,3113,3033,2938,2827,2702,2564,2414,2253,2082,1904,1719,1529,1336,1140,945,751,560,372,191,16,-151,-308,-455,-592,-717,-829,-929,-1015,-1088,-1148,-1194,-1228,-1248,-1257,-1253,-1239,-1214,-1180,-1137,-1087,-1030,-967,-900,-830,-757,-683,-608,-535,-462,-392,-326,-263,-205,-152,-105,-63,-28,1,23,39,48,51,48,39,25,6,-17,-44,-74,-107,-142,-179,-216,-253,-290,-326,-361,-393,-424,-451,-475,-496,-513,-526,-535,-540,-541,-538,-531,-521,-507,-489,-469,-446,-421,-394,-366,-336,-306,-275,-245,-215,-185,-157,-131,-106,-83,-62,-44,-28,-15,-4,4,9,12,12,10,6,-0,-8,-18,-29,-41,-54,-68,-81,-95,-109,-122,-135,-146,-157,-166,-174,-181,-186,-190,-192,-192,-190,-187,-183,-177,-169,-161,-151,-140,-129,-117,-104,-91,-78,-65,-53,-40,-28,-17,-7,3 };
static int16_t hbp_05[FILTER_LENGTH] = { -4,7,17,26,33,38,41,41,39,33,25,14,0,-16,-35,-54,-76,-97,-119,-141,-161,-180,-196,-210,-221,-228,-231,-231,-227,-219,-207,-192,-174,-154,-132,-110,-87,-65,-44,-25,-10,2,10,13,11,4,-9,-27,-50,-78,-110,-145,-182,-221,-261,-300,-338,-373,-404,-431,-452,-468,-476,-477,-472,-459,-439,-413,-381,-344,-304,-261,-217,-174,-132,-93,-59,-31,-10,3,7,2,-13,-38,-72,-116,-167,-226,-290,-358,-428,-499,-567,-633,-692,-744,-787,-819,-839,-846,-840,-820,-785,-738,-679,-609,-530,-444,-353,-261,-169,-81,-0,72,132,177,206,216,206,176,124,52,-39,-149,-275,-414,-564,-720,-879,-1036,-1186,-1326,-1449,-1552,-1630,-1679,-1696,-1677,-1620,-1524,-1386,-1208,-990,-733,-441,-115,239,618,1015,1424,1841,2257,2666,3061,3436,3784,4100,4377,4610,4796,4932,5014,5042,5014,4932,4796,4610,4377,4100,3784,3436,3061,2666,2257,1841,1424,1015,618,239,-115,-441,-733,-990,-1208,-1386,-1524,-1620,-1677,-1696,-1679,-1630,-1552,-1449,-1326,-1186,-1036,-879,-720,-564,-414,-275,-149,-39,52,124,176,206,216,206,177,132,72,-0,-81,-169,-261,-353,-444,-530,-609,-679,-738,-785,-820,-840,-846,-839,-819,-787,-744,-692,-633,-567,-499,-428,-358,-290,-226,-167,-116,-72,-38,-13,2,7,3,-10,-31,-59,-93,-132,-174,-217,-261,-304,-344,-381,-413,-439,-459,-472,-477,-476,-468,-452,-431,-404,-373,-338,-300,-261,-221,-182,-145,-110,-78,-50,-27,-9,4,11,13,10,2,-10,-25,-44,-65,-87,-110,-132,-154,-174,-192,-207,-219,-227,-231,-231,-228,-221,-210,-196,-180,-161,-141,-119,-97,-76,-54,-35,-16,0,14,25,33,39,41,41,38,33,26,17,7,-4 };
static int16_t hbp_15[FILTER_LENGTH] = { -53,-16,17,38,41,24,-10,-54,-100,-136,-154,-150,-124,-83,-36,6,31,33,10,-35,-93,-150,-194,-214,-207,-173,-120,-60,-9,21,21,-11,-69,-141,-211,-264,-287,-275,-230,-162,-88,-25,10,7,-35,-109,-198,-284,-347,-372,-353,-294,-208,-116,-40,0,-6,-61,-154,-265,-369,-443,-470,-441,-364,-256,-142,-49,-3,-15,-86,-203,-340,-467,-554,-581,-540,-439,-302,-160,-47,7,-13,-106,-253,-423,-578,-681,-708,-649,-517,-342,-163,-24,40,9,-113,-302,-517,-709,-833,-858,-775,-599,-370,-140,36,113,67,-97,-346,-626,-873,-1028,-1050,-929,-687,-377,-68,165,261,191,-39,-384,-769,-1106,-1313,-1333,-1150,-795,-343,106,443,580,469,116,-413,-1007,-1531,-1853,-1878,-1573,-977,-203,583,1194,1461,1274,615,-431,-1674,-2855,-3677,-3870,-3238,-1705,660,3644,6913,10063,12682,14415,15020,14415,12682,10063,6913,3644,660,-1705,-3238,-3870,-3677,-2855,-1674,-431,615,1274,1461,1194,583,-203,-977,-1573,-1878,-1853,-1531,-1007,-413,116,469,580,443,106,-343,-795,-1150,-1333,-1313,-1106,-769,-384,-39,191,261,165,-68,-377,-687,-929,-1050,-1028,-873,-626,-346,-97,67,113,36,-140,-370,-599,-775,-858,-833,-709,-517,-302,-113,9,40,-24,-163,-342,-517,-649,-708,-681,-578,-423,-253,-106,-13,7,-47,-160,-302,-439,-540,-581,-554,-467,-340,-203,-86,-15,-3,-49,-142,-256,-364,-441,-470,-443,-369,-265,-154,-61,-6,0,-40,-116,-208,-294,-353,-372,-347,-284,-198,-109,-35,7,10,-25,-88,-162,-230,-275,-287,-264,-211,-141,-69,-11,21,21,-9,-60,-120,-173,-207,-214,-194,-150,-93,-35,10,33,31,6,-36,-83,-124,-150,-154,-136,-100,-54,-10,24,41,38,17,-16,-53 };

void FiltersInit(void)
{
    CB_Init(&x_red);
    CB_Init(&x_ir);
    CB_Init(&x_red_filtered);
    CB_Init(&x_ir_filtered);
    setFilterFunction(BP_5Hz);
}

void setFilterFunction(FilterType filtertype)
{
    switch (filtertype)
    {
        case LP_5Hz:
        {
            h = hlp_05;
            h_len = 81;
            break;
        }
        case LP_15Hz:
        {
            h = hlp_15;
            h_len = 54;
            break;
        }
        case BP_3Hz:
        {
            h = hbp_03;
            h_len = 325;
            break;
        }
        case BP_5Hz:
        {
            h = hbp_05;
            h_len = 325;
            break;
        }
        case BP_15Hz:
        {
            h = hbp_15;
            h_len = 325;
            break;
        }
    }
}

void updateValues(int16_t red, int16_t ir)
{
    // Delay line for IR values
    CB_Add(&x_red, red);

    // Delay line for IR values
    CB_Add(&x_ir, ir);
}

int16_t FIROutput(CircularBuffer *values)
{
    volatile int i;

    int64_t y = 0;
    int index = values->writeIndex + 1;
    for (i = 0; i < h_len; i++)
    {
        y += (int64_t) values->Buffer[--index] * h[i];
        if (index == 0) index = CB_BUFFER_SIZE;
    }

    y /= FILTER_AMP;
    return y;
}

int16_t FIRRedOutput(void)
{
    int16_t red_filtered = FIROutput(&x_red);

    // Delay line for Red values filtered
    CB_Add(&x_red_filtered, red_filtered);

    return red_filtered;
}

int16_t FIRIROutput(void)
{
    int16_t ir_filtered = FIROutput(&x_ir);

    // Delay line for IR values filtered
    CB_Add(&x_ir_filtered, ir_filtered);

    return ir_filtered;
}

int16_t movingAvg(CircularBuffer *values, int16_t len)
{
    volatile int i;

    int64_t y = 0;
    int index = values->writeIndex + 1;
    for (i = 0; i < len; i++)
    {
        y += values->Buffer[--index];
        if (index == 0) index = CB_BUFFER_SIZE;
    }

    y /= len;
    return y;
}

int16_t movingRedAvg(void)
{
    return movingAvg(&x_red, AVERAGE_LENGTH);
}

int16_t movingIRAvg(void)
{
    return movingAvg(&x_ir, AVERAGE_LENGTH);
}

int16_t movingIRApprox(void)
{
    return movingAvg(&x_ir_filtered, 30);
}
